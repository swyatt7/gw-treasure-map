{% block alert_viz %}
<head>
<style>

.slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 25px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

.alerttypeactive {
  cursor: pointer;
  color: black;
  background-color:darkgray;
  outline: darkgray;
  border: darkgray;
}

div.constrained {
  overflow: auto;
  height: 100px;
}

</style>
</head>

<link rel="stylesheet" href="http://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.css" />
<link href="https://aladin.u-strasbg.fr/AladinLite/css/style.css" rel="stylesheet" />
<script type="text/javascript" src="http://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.js" charset="utf-8"></script>
    
<body>
  <input type="hidden" id="hidden_alertid" value="{{ form.selected_alert_info.id }}">

  <ul id='alerttypenav' class="nav nav-tabs">
    {% for al in form.alert_type_tabs if al['type']!= "Retraction" %}
      {% if al['type'] == form.alert_type %}
        <!-- <li class="active"><a href="/{{ form.page }}?graceids={{ form.graceid }}&pointing_status={{ form.status }}&alert_type={{ al['type'] }}">{{ al['type'] }} <br> {{al['timesent']}}</a></li>-->
        <li class="nav-item"><a class="alerttypeactive" id="{{ al['urlid']}}">{{ al['type'] }}<br>{{al['timesent']}}</a></li>
      {% else %}
        <li class="nav-item"><a id="{{ al['urlid']}}">{{ al['type'] }}<br>{{al['timesent']}}</a></li>
      {% endif %}
    {% endfor %}
  </ul>

  <div class='row'>
    <!-- The Aladin Viz -->
    <div class='column'style="float:left; width: 80%;">
      <div id="aladin-lite-div" style="position: relative;"></div>
    </div>
    <!-- Viz interaction column -->
    <div class="column" style="float: right; width: 20%; padding-left: 2%;">
      <div class="row">
        <h3> Follow-Up </h3>
      </div>
      <div class="row">
        <button style="margin-left: auto; margin-right: 0;" type="button" class="btn btn-primary btn-sm" data-toggle='collapse' data-target='#alert_instruments_div'>+</button> <h4 id='instrumentsHeader' style="display: inline-block;">...Loading...</h4> 
        <div class="collapse" id="alert_instruments_div"></div>
      </div>
      <div class="row">
        <button type="button" class="btn btn-primary btn-sm" data-toggle='collapse' data-target='#alert_grbcov_div'>+</button> <h4 style="display: inline-block;">GRB Coverage</h4> 
        <div class="collapse" id="alert_grbcov_div"></div>
      </div>
      <div class="row">
        <h3> Sources </h3>
      </div>
      <div class="row">
        <button type="button" class="btn btn-primary btn-sm" data-toggle='collapse' data-target='#alert_gal_div'>+</button> <h4 style="display: inline-block;">Galaxies</h4> <button type="button" id="alert_event_galaxies" class="btn btn-primary btn-sm">Get</button>
        <div class="collapse" id='alert_gal_div'></div>
      </div>
      <div class="row">
        <button type="button" class="btn btn-primary btn-sm" data-toggle='collapse' data-target='#alert_scimmadiv'>+</button> <h4 style="display: inline-block;">XRT Sources</h4> <button type="button" id="alert_scimma_xrt" class="btn btn-primary btn-sm">Get</button>
        <div class="collapse" id ="alert_scimmadiv"></div>
      </div>
    </div>
    </div>
  </div>

  <!-- pointing status selection and timeslider-->
  <div>
    <p><b>Pointing Status</b> 
      <select class='selectpicker' name=pointing_status id=pointing_status>
        {% for a in form.pointing_status %}
          {% if a['value'] == form.status %}
            <option selected='True' value={{ a['value'] }}>{{ a['name'] }}</option>
          {% else %}
            <option value={{ a['value'] }}>{{ a['name'] }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </p>

    <p>
      <label for="amount">Date range (days since Time of Signal):</label>
      <input type="text" id="amount" style="border: 0; color: #f6931f; font-weight: bold;" size="100"/>
    </p>
     
    <div id="slider-range"></div>
  </div>

  <!-- GW Alert Information -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <table class="table">
          <thead>
            <tr>
              <th>Information</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr>
            {% if form.selected_alert_info.group != 'None' and form.selected_alert_info.group != '' and form.selected_alert_info.group != None %}
            <tr class="info">
              <td>Group</td>
              <td id='alert_group'>{{ form.selected_alert_info.group }}</td>
            </tr>
            {% endif %}
            <tr class="info">
              <td>Detectors</td>
              <td id='alert_detectors'>{{ form.selected_alert_info.detectors }}</td>
            </tr>
            <tr class="info">
              <td>Time of Signal</td>
              <td id='alert_time_of_signal'>{{ form.selected_alert_info.time_of_signal }} UTC</td>
            </tr>
            <tr class="info">
              <td>Time Sent</td>
              <td id='alert_timesent'>{{ form.selected_alert_info.timesent }} UTC</td>
            </tr>
            <tr class="info">
              <td>False Alarm Rate</td>
              <td id='alert_human_far'>once per {{form.selected_alert_info.human_far}} {{form.selected_alert_info.human_far_unit}}</td>
            </tr>
            {% if form.selected_alert_info.group != 'Burst' %}
            <tr class="info">
              <td>Distance</td>
              <td id='alert_distance_plus_error'>{{ form.distance }} +/- {{ form.distance_error }} Mpc</td>
            </tr>
            {% else %}
            <tr class="info">
              <td>Central Frequency</td>
              <td id='alert_centralfreq'>{{form.selected_alert_info.centralfreq}} Hz</td>
            </tr>
            <tr class="info">
              <td>Duration</td>
              <td id='alert_duration'>{{form.selected_alert_info.duration}} seconds</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if form.selected_alert_info.group != 'Burst' %}
      <div class="col-sm-6">
        <table class="table">
          <thead>
            <tr>
              <th>Classification (CBC Only)</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr class="info">
              <td>BNS</td>
              <td id='alert_prob_bns'>{{ form.selected_alert_info.prob_bns }}</td>
            </tr>
            <tr class="info">
              <td>NSBH</td>
              <td id='alert_prob_nsbh'>{{ form.selected_alert_info.prob_nsbh }}</td>
            </tr>
            <tr class="info">
              <td>Mass Gap</td>
              <td id='alert_prob_gap'>{{ form.selected_alert_info.prob_gap }}</td>
            </tr>
            <tr class="info">
              <td>BBH</td>
              <td id='alert_prob_bbh'>{{ form.selected_alert_info.prob_bbh }}</td>
            </tr>
            <tr class="info">
              <td>Terrestrial</td>
              <td id='alert_prob_terrestrial'>{{ form.selected_alert_info.prob_terrestrial }}</td>
            </tr>
            <tr class="info">
              <td>Has NS</td>
              <td id='alert_prob_hasns'>{{ form.selected_alert_info.prob_hasns }}</td>
            </tr>
            <tr class="info">
              <td>Has Remnant</td>
              <td id='alert_prob_hasremenant'>{{ form.selected_alert_info.prob_hasremenant }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

<!-- BEGIN: coverage calculator -->
<div class = "container-fluid">
  <center><h3>Coverage Calculator</h3></center>

  <br>

  <i> 
    Calculate the coverage of the GW localization over time, 
    with choices to limit the coverage calculation to particular sets of instruments, 
    wavelengths, or depth. All fields are optional, but cuts on depths must have an associated unit. 
    If an empty form is submitted, the total reported coverage regardless of depth or band is computed. 
    Once a HEALPIX pixel has been first covered, it is marked as done, to avoid double counting probability 
    when the same field is covered multiple times. After clicking, be patient, it may take up to 20 seconds 
    to fully compute the coverage profile.
  </i>

  <br>

  <!-- Coverage plot placeholder -->
  <div id ="coveragediv"></div>
  
  <!-- Coverage plot input parameters-->
  <b>Instrument</b>
  <select class="selectpicker" multiple data-live-search="true" name=inst_cov id=inst_cov>
      {% for a in form.inst_cov %}
          <option value={{ a['value'] }}>{{ a['name'] }}</option>
      {% endfor %}
  </select>
  <b>Band</b>
  <select class="selectpicker" multiple data-live-search="true" name=band_cov id=band_cov>
      {% for a in form.band_cov %}
        <option value={{ a['value'] }}>{{ a['name'] }}</option>
      {% endfor %}
  </select>
  <b>Depth</b>
  <input type="text" name=depth_cov id=depth_cov>
  <b>Depth Unit</b>
  <select class="selectpicker" multiple data-max-options="1" name=depth_unit id=depth_unit>
      {% for a in form.depth_unit %}
        {% if 'erg' in a['name'] %}
        <option value={{ a['value'] }}>FLUX erg cm^-2 s^-1</option>
        {% else %}
        <option value={{ a['value'] }}>{{ a['name'] }}</option>
        {% endif %}
      {% endfor %}
  </select>
  <br><br>
  <input type="button" id="calculate" value="Calculate" class="btn btn-primary" style="display: block; margin: 0 auto;"/>
</div>
    
<!-- Creation of Aladin Lite instance with initial parameters -->
<script type='text/javascript'>

  var inst_overlays = {}
  
  var target_init = "{{ form.avgra }} {{ form.avgdec }}"
  var detection_overlays = JSON.parse('{{ detection_overlays | tojson }}');
  var GRBoverlays = JSON.parse('{{ GRBoverlays | tojson }}');
  var galaxy_cats = JSON.parse('{{ galaxy_cats | tojson }}');

  var sun_ra = '{{ form.selected_alert_info.sun_ra }}';
  var sun_dec = '{{ form.selected_alert_info.sun_dec }}';
  var moon_ra = '{{ form.selected_alert_info.moon_ra }}';
  var moon_dec = '{{ form.selected_alert_info.moon_dec }}';

  var slider_min = new Number('{{ form.mintime }}');
  var slider_max = new Number('{{ form.maxtime }}');
  var slider_step = new Number('{{ form.step }}');
  var slider_vals = [(slider_min), (slider_max)];
</script>
<script type='text/javascript' src="{{ url_for('static',filename='js/alert_aladin.js') }}"></script>
<script type='text/javascript'>
  var data = {
    detection_overlays: detection_overlays,
    inst_overlays: inst_overlays,
    GRBoverlays: GRBoverlays,
    target_init: target_init,
    sun_ra: sun_ra,
    sun_dec: sun_dec,
    moon_ra: moon_ra,
    moon_dec: moon_dec,
  }
  var d = gwtmAladinInit(data)
  data.aladin = d.aladin
  var aladin = d.aladin
  var detectionoverlaylist = d.detectionoverlaylist
  var instoverlaylist = {}
  var grboverlaylist = d.grboverlaylist

  window.onload = function(){
    $('#instrumentsHeader').text('...Loading...')
    $.ajax(
      {
        url: '/ajax_alertinstruments_footprints',
        data: 'graceid={{ form.graceid }}&tos_mjd={{ form.tos_mjd }}',
        async: true
      }
    ).done( function(payload){
      data.inst_overlays = payload
      aladin_drawInstHTML(data.inst_overlays, 'alert_instruments_div')
      instoverlaylist = aladin_setContours(aladin, payload)
      aladin.view.requestRedraw();
      $('#instrumentsHeader').text('Instruments')
    });
  }
</script>
<!-- Page Interaction JS -->
<script>
  $(document).ready( function() {
    $('#alert_instruments_div').click(function(event) {
      if (event.target.id != '') { 
        aladin_overlayToggle(event.target, instoverlaylist)
      }
    })
    $('#alert_grbcov_div').click(function(event) {
      if (event.target.id != '') {
        aladin_mocToggle(event.target, grboverlaylist)
      }
    })
  });

  //redraw with new contour
  $(document).ready( function() {
    $('#alerttypenav').click(function(event) {
      var actives = document.getElementsByClassName('alerttypeactive')
      var thisEl = document.getElementById(event.target.id)
      for(i = 0; i<actives.length; i++){
        actives[i].classList.remove('alerttypeactive')
      }
      thisEl.classList.add('alerttypeactive')

      $.ajax(
        {
          url: '/ajax_alerttype',
          data: 'urlid='+thisEl.id
        }
      ).done(function (payload){
        $('#hidden_alertid').val(payload['hidden_alertid']);
        $('#alert_group').text(payload['alert_group']);
        $('#alert_detectors').text(payload['alert_detectors']);
        $('#alert_time_of_signal').text(payload['alert_time_of_signal']);
        $('#alert_timesent').text(payload['alert_timesent']);
        $('#alert_human_far').text(payload['alert_human_far']);
        $('#alert_distance_plus_error').text(payload['alert_distance_plus_error']);
        $('#alert_centralfreq').text(payload['alert_centralfreq']);
        $('#alert_duration').text(payload['alert_duration']);
        $('#alert_prob_bns').text(payload['alert_prob_bns']);
        $('#alert_prob_nsbh').text(payload['alert_prob_nsbh']);
        $('#alert_prob_gap').text(payload['alert_prob_gap']);
        $('#alert_prob_bbh').text(payload['alert_prob_bbh']);
        $('#alert_prob_terrestrial').text(payload['alert_prob_terrestrial']);
        $('#alert_prob_hasns').text(payload['alert_prob_hasns']);
        $('#alert_prob_hasremenant').text(payload['alert_prob_hasremenant']);

        //aladin_removeContour(detectionoverlaylist);
        //aladin.view.requestRedraw();
        aladin.removeLayers()
        data.detection_overlays = payload.detection_overlays;
        
        d = gwtmAladinInit(data)
        aladin = d.aladin
        detectionoverlaylist = d.detectionoverlaylist
        instoverlaylist = d.instoverlaylist
        grboverlaylist = d.grboverlaylist
        //detectionoverlaylist = aladin_setContours(aladin, detection_overlays)
      })
    })
  })

  //Function that creates the Coverage plot
  $(document).ready( function() {
      $('#calculate').click(function() {
        var $btn = $(this).button('loading');
        var inst_cov = $('#inst_cov').val()
        var band_cov = $('#band_cov').val()
        var depth_cov = $('#depth_cov').val()
        var depth_unit = $('#depth_unit').val()
        $.ajax(
          {
              url: '/ajax_coverage_calculator',
              data: 'graceid={{ form.graceid }}&mappathinfo={{ form.mappathinfo }}&inst_cov='+inst_cov+'&band_cov='+band_cov+'&depth_cov='+depth_cov+'&depth_unit='+depth_unit
          }
        ).done(function (reply) {
          $('#coveragediv').html(reply);
          $btn.button('reset');
        });
      });
  });
  //disables/enables the button
  $(document).ready(function () {
    $(document).ajaxStart(function () {
      $('#calculate').addClass('disabled');
    }).ajaxStop(function (){
      $('#calculate').removeClass('disabled');
    });
  });

  //getting the alert event galaxies
  $(document).ready( function() {
    $('#alert_event_galaxies').click(function() {
      var $btn = $(this).button('loading');
      var alertid = document.getElementById('hidden_alertid').value;
      $.ajax(
        {
            url: '/ajax_event_galaxies',
            data: 'alertid='+alertid
        }
      ).done(function (event_galaxies) {
        if (event_galaxies.length > 0) {
          aladin_setMarkers(aladin, event_galaxies)
          aladin_setMarkerHtml(event_galaxies, 'alert_gal_div')
        } else {
          var html = "<p>No Results</p>"
          $('#alert_gal_div').html(html);
        }
        $btn.button('reset');
      });
    });
  });
  //disables/enables the XRT button
  $(document).ready(function () {
    $(document).ajaxStart(function () {
      $('#alert_event_galaxies').addClass('disabled');
    }).ajaxStop(function () {
      $('#alert_event_galaxies').removeClass('disabled');
    });
  });

  //Function that calls the XRT sources and populates them 
  // on the aladin viz
  $(document).ready( function() {
    $('#alert_scimma_xrt').click(function() {
      var $btn = $(this).button('loading');
      $.ajax(
        {
            url: '/ajax_scimma_xrt',
            data: 'graceid={{ form.graceid }}'
        }
      ).done(function (scimma_xrt_sources) {
        if (scimma_xrt_sources.length > 0) {
          var xrt_layer = A.catalog({name:'XRT Sources'});
          for (i = 0; i < scimma_xrt_sources.length; i++) {
                var marker = A.marker(
                  scimma_xrt_sources[i].ra, 
                  scimma_xrt_sources[i].dec, 
                  {
                    popupTitle: 'Source', 
                    popupDesc: scimma_xrt_sources[i].info
                  }
                )
                xrt_layer.addSources([marker])
          }
          xrt_layer.hide
          aladin.addCatalog(xrt_layer)
        } else {
          var html = '<p>No results</p>'
          $('#alert_scimmadiv').html(html);
        }
        $btn.button('reset');
      });
    });
  });

  //disables/enables the XRT button
  $(document).ready(function () {
    $(document).ajaxStart(function () {
      $('#alert_scimma_xrt').addClass('disabled');
    }).ajaxStop(function () {
      $('#alert_scimma_xrt').removeClass('disabled');
    });
  });

  //redraws the screen when changing pointing status dropdown
  $('#pointing_status').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
    $('#instrumentsHeader').text('...Loading...')
    $.ajax(
      {
        url: '/ajax_alertinstruments_footprints',
        data: 'graceid={{ form.graceid }}&tos_mjd={{ form.tos_mjd }}&pointing_status='+$(this).val(),
        async: true
      }
    ).done( function(payload){
      data.inst_overlays = payload
      aladin.removeLayers()
      d = gwtmAladinInit(data)
      detectionoverlaylist = d.detectionoverlaylist
      instoverlaylist = d.instoverlaylist
      grboverlaylist = d.grboverlaylist
      $('#instrumentsHeader').text('Instruments')
    });
  });
</script>
  </body>
{% endblock %}